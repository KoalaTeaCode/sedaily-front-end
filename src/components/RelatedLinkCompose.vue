<template>
  <div>
    <textarea
      placeholder='Add a related link...'
      class='related-link-box'
      :disabled="isSubmitting"
      name="url"
      v-validate="'required|url'"
      type='text'
      v-model='url' />

    <div
      v-show="errors.has('url')"
      class="alert alert-danger">
      {{ errors.first('url') }}</div>

    <input
      placeholder='Add a short title...'
      class='related-title-box'
      :disabled="isSubmitting"
      name="title"
      v-validate="'required'"
      type='text'
      v-model='title' />

    <div
      v-show="errors.has('title')"
      class="alert alert-danger">
      {{ errors.first('title') }}</div>

    <span v-if="isSubmitting">
      <spinner :show="true" />
    </span>

    <div v-else>
      <button
        class='button-submit'
        :disabled="isSubmitting"
        @click.prevent='submit'>Add New Link</button>
    </div>
  </div>
</template>

<script>
import Spinner from 'components/Spinner'
import { mapState, mapActions } from 'vuex'

export default {
  name: 'related-link-compose',
  components: {
    Spinner
  },
  data () {
    return {
      url: '',
      title: '',
      isSubmitting: false,
      loading: true
    }
  },
  computed: {
    ...mapState([
      'me'
    ]),

    postId () {
      return this.$route.params.id
    }
  },
  methods: {
    ...mapActions([
      'relatedLinksCreate',
      'relatedLinksFetch'
    ]),

    submit () {
      return this.$validator.validateAll().then((result) => {
        if (result) {
          this.isSubmitting = true
          this.relatedLinksCreate({
            postId: this.postId,
            title: this.title,
            url: this.url
          })
            .then((response) => {
              this.url = ''
              this.title = ''
              this.isSubmitting = false
              // Fetch comments
              this.relatedLinksFetch({ postId: this.postId })
            })
            .catch((error) => {
              this.isSubmitting = false
              this.$toasted.error(error.response.data.message)
            })
        } else {
          this.$toasted.error('Sorry there was a problem :(')
        }
      })
    }
  }
}
</script>

<style scoped lang="stylus">
.related-link-box
  width 100%
  padding 10px
  margin-bottom 12px
  border-radius 4px
  border-color #c5c5c5

.related-title-box
  width 100%
  padding 10px
  margin-bottom 12px
  border none
  border-bottom 1px solid #ccc
</style>
